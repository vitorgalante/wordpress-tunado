<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.1/build/css/intlTelInput.css">
<style>
.iti { width: 100%; position: relative; }
.iti input, .iti input.jet-form__field { width: 100%; box-sizing: border-box; }
.iti input.jet-form__field.text-field { min-height: 40px; }
.iti__country-list { max-width: 300px; }
input.error { border: 2px solid #e74c3c !important; }
</style>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.1/build/js/intlTelInput.min.js"></script>
<script>
jQuery(document).ready(function($) {
    var instances = {};
    var counter = 0;
    
    function init(input, force) {
        // Cria ID √∫nico para cada input
        if (!input.dataset.itiId) {
            input.dataset.itiId = 'iti_' + (++counter);
        }
        var id = input.dataset.itiId;
        
        console.log('Init input ID:', id, 'Force:', force);
        
        if (force || !instances[id]) {
            // Destroi inst√¢ncia antiga se existir
            if (instances[id]) {
                console.log('Destruindo inst√¢ncia:', id);
                try {
                    instances[id].destroy();
                } catch(e) {}
                delete instances[id];
            }
            
            var $form = $(input).closest('form');
            var hidden = $form.find('input[name="telefone"]')[0];
            
            if (!hidden) {
                console.warn('Campo oculto n√£o encontrado para:', id);
                return;
            }
            
            console.log('Criando nova inst√¢ncia:', id);
            
            var iti = window.intlTelInput(input, {
                initialCountry: "br",
                preferredCountries: ["br", "us", "pt"],
                separateDialCode: true,
                nationalMode: false,
                formatOnDisplay: true,
                autoPlaceholder: "aggressive",
                strictMode: true,
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.1/build/js/utils.js"
            });
            
            instances[id] = iti;
            console.log('‚úÖ Inst√¢ncia criada:', id);
            
            function sync() {
                if (iti.isValidNumber()) {
                    hidden.value = iti.getNumber();
                    console.log('üìû Sincronizado [' + id + ']:', hidden.value);
                } else {
                    hidden.value = '';
                    console.log('‚ùå Inv√°lido [' + id + '], limpo');
                }
            }
            
            // Remove listeners antigos e adiciona novos
            $(input).off('input.iti countrychange.iti');
            $(input).on('input.iti', sync);
            $(input).on('countrychange.iti', sync);
            
            // Submit com namespace √∫nico
            $form.off('submit.iti_' + id).on('submit.iti_' + id, function(e) {
                console.log('üì§ Submit [' + id + ']');
                
                if (!iti.isValidNumber()) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    input.classList.add('error');
                    alert('Por favor, insira um telefone v√°lido.');
                    console.log('‚ùå Bloqueado [' + id + ']');
                    return false;
                }
                
                sync(); // Sincroniza antes de enviar
                console.log('‚úÖ V√°lido [' + id + '], valor final:', hidden.value);
            });
            
            // Sincroniza se j√° tiver valor
            if (input.value) {
                setTimeout(sync, 100);
            }
        } else {
            console.log('‚è≠Ô∏è Inst√¢ncia j√° existe:', id);
        }
    }
    
    // Inicializa inputs VIS√çVEIS da p√°gina
    console.log('üöÄ Inicializando p√°gina...');
    $('input[name="pseudo_telefone"]:visible').each(function() {
        init(this, false);
    });
    
    // Popup - FOR√áA reinicializa√ß√£o
    $(window).on('elementor/popup/show', function(event, id) {
        console.log('üéâ Popup aberto:', id);
        
        setTimeout(function() {
            console.log('Procurando inputs no popup...');
            var $inputs = $('.elementor-popup-modal:visible input[name="pseudo_telefone"]');
            console.log('Encontrados:', $inputs.length);
            
            $inputs.each(function() {
                init(this, true); // FOR√áA
            });
        }, 300);
    });
    
    console.log('‚úÖ Script pronto!');
});
</script>
